#!/bin/sh

set -e

die() {
	echo "$@" >&2
	exit 1
}

sqlexec=`which sqlite3`
[ -x "$sqlexec" ] || die "E: Missing sqlite3 executable"

me=`basename $0`
usage() {
	echo >&2 "Usage:"
	echo >&2 "    $me create <name> [<cardfile>...]"
	echo >&2 "    $me update <name> <cardfile> [<cardfile>...]"
	echo >&2 "    $me verify <name>"
	echo >&2 "    $me dump   <name> <dir>"
	exit 1
}

[ "$#" -ge 2 ] || usage
action="$1"
name="$2"

conf="/etc/memorize-flashcards/conf"
[ -e "$conf" ] || die "E: Missing configuration: $conf"

read_conf_var() {
	varname="$1"
	grep "^$varname\s\+" "$conf" | awk '{print $2}'
}

dbroot="`read_conf_var DBROOT`"
dbpath="$dbroot/${name}.db"
create_db() {
	local name="$1"

	# Sanity: Make sure course db is not already there
	[ -e "$dbpath" ] && die "E: Course already exists: $dbpath (To add cards use the action: update)"

	# Construct schema
	cards_schema=$(cat <<-EOF
		id INTEGER PRIMARY KEY AUTOINCREMENT,
		path text NOT NULL UNIQUE,
		hash text NOT NULL UNIQUE,
		lesson int,
		period int
	EOF
	)

	# Create new course database and an empty cards table
	$sqlexec "$dbpath" "CREATE TABLE cards ($cards_schema);"
}

cards_dir=`read_conf_var CARDSROOT`
add_card() {
	local dbname="$1"
	local cardfile="$2"
	[ -f "$cardfile" ] || die "Missing card file: $cardfile"

	cardhash=`md5sum "$cardfile" | awk '{print $1}'`
	carddest="$cards_dir/${cardhash}.card"
	if ! [ -f "$carddest" ]; then
		echo "D: Copy $cardfile --> $carddest"
		cp "$cardfile" "$carddest" # Possibly card exists in other course, and needs to be added to db only
	fi

	# Check if value exists on db already
	card_exists=$($sqlexec "$dbpath" "SELECT CASE WHEN EXISTS (SELECT 1 FROM cards WHERE hash = '$cardhash') THEN CAST (1 AS BIT) ELSE CAST (0 AS BIT) END;")
	if [ "$card_exists" = 1 ]; then
		echo >&2 "W: $cardfile already exists in course db"
	else
		echo "D: Insert db record ('$carddest', '$cardhash', 1, 1)"
		$sqlexec "$dbpath" "INSERT INTO cards ('path', 'hash', 'lesson', 'period') VALUES ('$carddest', '$cardhash', 1, 1);"

		# Increase reference count of the card in cards.list
		cards_list="$cards_dir/cards.list"
		if grep "$cardhash" "$cards_list" --quiet; then
			refcount=`grep "$cardhash" "$cards_list" | awk '{ print $2 }'`
			refcount=$((refcount+1))
			sed -i "s,${cardhash}.*,${cardhash}\t${refcount}," $cards_list
		else
			echo "$cardhash\t1" >> "$cards_list"
		fi
	fi
}

case "$action" in
	create)
		create_db "$name"
		shift
		shift
		for cardfile in "$@"; do
			add_card "$name" "$cardfile"
		done
		;;
	update)
		[ "$#" -ge 3 ] || usage
		[ -e "$dbpath" ] || die "E: Course missing (searched $dbpath)"
		shift
		shift
		for cardfile in "$@"; do
			add_card "$name" "$cardfile"
		done
		;;
	verify)
		die "$action: Not yet implemented"
		;;
	dump)
		die "$action: Not yet implemented"
		;;
	*)
		die "E: Unknown action: $action"
		;;
esac
