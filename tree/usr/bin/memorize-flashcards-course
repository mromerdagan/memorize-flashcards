#!/bin/sh

set -e

die() {
	echo "$@" >&2
	exit 1
}

me=`basename $0`
usage() {
	echo >&2 "Usage:"
	echo >&2 "    $me create <coursename> [<cardfile>...]"
	echo >&2 "    $me add-cards <coursename> <cardfile> [<cardfile>...]"
	echo >&2 "    $me verify <coursename>"
	echo >&2 "    $me dump   <coursename> <dir>"
	echo >&2 "    $me list"
	echo >&2 "    $me show-course <coursename>"
	echo >&2 "    $me update-card <coursename> <cardhash> <new-lesson-val> <new-period-val>"
	echo >&2 "    $me show-card <cardhash>"
	exit 1
}

[ "$#" -ge 1 ] || usage
action="$1"

conf="/etc/memorize-flashcards/conf"
[ -e "$conf" ] || die "E: Missing configuration: $conf"

read_conf_var() {
	varname="$1"
	grep "^$varname\s\+" "$conf" | awk '{print $2}'
}

dbroot="`read_conf_var DBROOT`"
create_empty_db() {
	local coursename="$1"
	local coursetable="$dbroot/${coursename}.db"
	# Sanity: Make sure course db is not already there
	[ -e "$coursetable" ] && die "E: Course already exists: $coursetable (To add cards use the action: update)"

	## Create new course database and an empty cards table
	touch "$coursetable"
	echo "# Hash\t\t\t\t\t\tPath\t\t\t\t\t\t\t\t\t\tLesson\tPeriod" > "$coursetable"
}

cards_dir=`read_conf_var CARDSROOT`
cards_table="$cards_dir/cards.table"
add_card() {
	local coursename="$1"
	local cardfile="$2"
	local coursetable="$dbroot/${coursename}.db"
	[ -f "$coursetable" ] || die "E: Missing course table: $coursetable"
	if ! [ -f "$cardfile" ]; then
		echo >&2 "W: Missing card file: $cardfile"
		return
	fi

	cardhash=`md5sum "$cardfile" | awk '{print $1}'`
	if grep --silent "^$cardhash" "$coursetable"; then # Card already exists in course table, nothing to do
		echo >&2 "W: $cardfile already exists in course table"
		return
	fi

	carddest="$cards_dir/${cardhash}.card"
	# Copy card file
	if ! [ -f "$carddest" ]; then # Possibly card already exists in other course, and only needs to be added to card table
		echo "I: Copy $cardfile --> $carddest"
		cp "$cardfile" "$carddest"
	fi

	# Add card record to course table
	echo "I: Insert card record ('$carddest', '$cardhash', -, -)"
	echo "$cardhash\t\t$carddest\t-\t-" >> "$coursetable"

	# Increase reference count of the card in cards.list
	if grep "^$cardhash" "$cards_table" --quiet; then
		refcount=`awk  -vcardhash="$cardhash" '$1 == cardhash { print $3 }' "$cards_table"`
		refcount=$((refcount+1))
		sed -i "s,${cardhash}.*,${cardhash}\t`basename ${carddest}`\t${refcount}," $cards_table
	else
		echo "$cardhash\t`basename ${carddest}`\t1" >> "$cards_table"
	fi
}

case "$action" in
	create)
		[ "$#" -ge 2 ] || usage
		coursename="$2"
		create_empty_db "$coursename"
		shift
		shift
		[ -f "$cards_table" ] || touch "$cards_table"
		for cardfile in "$@"; do
			add_card "$coursename" "$cardfile"
		done
		;;
	add-cards)
		[ "$#" -ge 3 ] || usage
		coursename="$2"
		coursetable="$dbroot/${coursename}.db"
		[ -e "$coursetable" ] || die "E: Course missing (searched $coursetable)"
		shift
		shift
		for cardfile in "$@"; do
			add_card "$coursename" "$cardfile"
		done
		;;
	verify)
		[ "$#" -eq 2 ] || usage
		coursename="$2"
		die "$action: Not yet implemented"
		;;
	dump)
		[ "$#" -eq 3 ] || usage
		coursename="$2"
		destdir="$3"
		die "$action: Not yet implemented"
		;;
	list)
		ls -1 "$dbroot"/*.db 2>/dev/null | sed -e "s,$dbroot/,," -e 's,.db$,,' || :
		;;
	show-course)
		[ "$#" -eq 2 ] || usage
		coursename="$2"
		coursetable="$dbroot/${coursename}.db"
		[ -f "$coursetable" ] || die "E: Course missing (searched $coursetable)"
		cat "$coursetable"
		;;
	update-card)
		[ "$#" -eq 5 ] || usage
		coursename="$2"
		cardhash="$3"
		lesson="$4"
		period="$5"

		coursetable="$dbroot/${coursename}.db"
		[ -f "$coursetable" ] || die "E: Course missing (searched $coursetable)"
		
		record=`grep "^$cardhash" "$coursetable"`
		carddest=$(echo "$record" | awk '{print $2}')
		new_record="$cardhash\t\t$carddest\t$lesson\t$period"
		sed -i "s,^$cardhash.*,$new_record," "$coursetable"
		;;
	show-card)
		[ "$#" -eq 2 ] || usage
		cardhash="$2"
		grep "^$cardhash" "$cards_table" --quiet || die "E: Card not found in cards table ($cards_table)"
		cardbase=`awk  -vcardhash="$cardhash" '$1 == cardhash { print $2 }' "$cards_table"`
		cardfile="$cards_dir/$cardbase"
		[ -f "$cardfile" ] || die "E: Card table pointing to missing file: $cardfile"
		cat "$cardfile"
		;;
	*)
		die "E: Unknown action: $action"
		;;
esac
