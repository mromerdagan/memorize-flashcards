#!/bin/sh

set -e

die() {
	echo "$@" >&2
	exit 1
}

sqlexec=`which sqlite3`
[ -x "$sqlexec" ] || die "E: Missing sqlite3 executable"

me=`basename $0`
usage() {
	echo >&2 "Usage:"
	echo >&2 "    $me create <coursename> [<cardfile>...]"
	echo >&2 "    $me update <coursename> <cardfile> [<cardfile>...]"
	echo >&2 "    $me verify <coursename>"
	echo >&2 "    $me dump   <coursename> <dir>"
	echo >&2 "    $me list"
	exit 1
}

[ "$#" -ge 1 ] || usage
action="$1"

conf="/etc/memorize-flashcards/conf"
[ -e "$conf" ] || die "E: Missing configuration: $conf"

read_conf_var() {
	varname="$1"
	grep "^$varname\s\+" "$conf" | awk '{print $2}'
}

dbroot="`read_conf_var DBROOT`"
create_empty_db() {
	local coursename="$1"
	local coursetable="$dbroot/${coursename}.db"
	# Sanity: Make sure course db is not already there
	[ -e "$coursetable" ] && die "E: Course already exists: $coursetable (To add cards use the action: update)"

	## Create new course database and an empty cards table
	#$sqlexec "$coursetable" "CREATE TABLE cards ($cards_schema);"
	touch "$coursetable"
	echo "# Hash          Path        Lesson  Period" > "$coursetable"
}

cards_dir=`read_conf_var CARDSROOT`
cards_table="$cards_dir/cards.table"
add_card() {
	local coursename="$1"
	local cardfile="$2"
	local coursetable="$dbroot/${coursename}.db"
	[ -f "$coursetable" ] || die "Missing course table: $coursetable"
	[ -f "$cardfile" ] || die "Missing card file: $cardfile"

	cardhash=`md5sum "$cardfile" | awk '{print $1}'`
	if grep --silent "$cardhash" "$coursetable"; then # Card already exists in course table, nothing to do
		echo >&2 "W: $cardfile already exists in course table"
		return
	fi

	carddest="$cards_dir/${cardhash}.card"
	# Copy card file
	if ! [ -f "$carddest" ]; then # Possibly card already exists in other course, and only needs to be added to card table
		echo "D: Copy $cardfile --> $carddest"
		cp "$cardfile" "$carddest"
	fi

	# Add card record to course table
	echo "D: Insert card record ('$carddest', '$cardhash', 1, 1)"
	echo "$cardhash\t$carddest\t-\t-" >> "$coursetable"

	# Increase reference count of the card in cards.list
	if grep "$cardhash" "$cards_table" --quiet; then
		refcount=`grep "$cardhash" "$cards_table" | awk '{ print $2 }'`
		refcount=$((refcount+1))
		sed -i "s,${cardhash}.*,${cardhash}\t${refcount}," $cards_table
	else
		echo "$cardhash\t1" >> "$cards_table"
	fi
}

case "$action" in
	create)
		[ "$#" -ge 2 ] || usage
		coursename="$2"
		create_empty_db "$coursename"
		shift
		shift
		for cardfile in "$@"; do
			add_card "$coursename" "$cardfile"
		done
		;;
	update)
		[ "$#" -ge 3 ] || usage
		coursename="$2"
		[ -e "$coursetable" ] || die "E: Course missing (searched $coursetable)"
		shift
		shift
		for cardfile in "$@"; do
			add_card "$coursename" "$cardfile"
		done
		;;
	verify)
		[ "$#" -eq 2 ] || usage
		coursename="$2"
		die "$action: Not yet implemented"
		;;
	dump)
		[ "$#" -eq 3 ] || usage
		coursename="$2"
		destdir="$3"
		die "$action: Not yet implemented"
		;;
	list)
		ls -1 "$dbroot"/*.db
		;;
	*)
		die "E: Unknown action: $action"
		;;
esac
